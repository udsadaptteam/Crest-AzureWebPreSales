const ContactDetails_API_URL = "https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b24e853747874880bdf04493df9ed795/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=7lybcuZ-KGEelJDTz0U2L3FPRgp9_M-09lgHKsKGi3Q";

const BRANDS_API_URL = "https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b5f43aedd6e74052af9b1e60d9edee12/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=flFE8l3SrhfMjM4lzdF7I8TsEO8E6gr-_9bqhY7QkQw";

const HEAR_ABOUT_API_URL = "https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/6ed010834ac6422ca2679db0d3bf1a67/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=PTWDxa9a_dIVUAXG9xcJFjWaR_VFUa0NBT4yj4kjsk4";

const BUSINESS_EXPERIENCE_API_URL = "https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1b0ba77a781b4e15a7f047598443a854/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=DIfGi4Vm20b_MXv0VgD7rSZbL9mST7ifzwICuvRNr9c";

const PersonalDetails_API_URL ="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d4ba83ff4e96415da1544f419719a9d6/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=WlXAxUPX754-e8HR5gNEfLFEPA9og8B3ABhK4icn1Hg";

const EmploymentDetails_API_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4a55e3a2b08d4fd594a67253fe89fbdf/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=raMSIbILhWZ500yB5rjvO3xoWnxDuaZXRv-RmMfx1lA";

const CO_APPLICANT_GET_FLOW_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/0e96ab320960498284831e1a6b0c0573/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=707zv2aVdFrEhaBUk_nafDMRX_4nGa-th24nY7DJ2EY";

const CO_APPLICANT_POST_FLOW_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/488910c988d84422b1935f966b1d42bd/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=_kOOYAng0UDg8Al7mF6y6phtcK8JpgU9WRYad7sfB6M";

const FINANCIAL_POST_FLOW_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/5a0569a211b54107bce260beea78513a/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=oL71pmjLi2kmWCl4HP0jXx-uIeQZ3QIA1sU9ferdd4M";

const BUSINESS_POST_FLOW_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c7d3a98654f04820a2d14d297d20b986/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=6wga409fWg6ACMyc4-WcF7R_apHJDCn31xDP6yqQhts";

const OTHER_QUESTION_POST_FLOW_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/5520c2b73da84688aeb850d28500dd61/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=amhbzXN6lk3LL1UvBp2idlEQQvrnOCGSlYP2Q7_200o";

const PREFERRED_LOCATION_POST_FLOW_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c7bdfdf03a7a4fd4a05ca5edf245c2f4/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=giDwPnKTsYQRhHVCAroXjaskp5G-e4bHtLOD6rLFrTE";

const REAL_ESTATE_FLOW_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8d03c2584199494895d78704a28c4681/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jPajX-3lGCV8wAam0UTe2IhQpXxFZA1gsoTCAt0i3ok";

const REAL_ESTATE_GETBYID_FLOW_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/80f4813c454c4528b24734c68e89b89b/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Bwym6KI9_mPVsYN8XReX_ZeAi3EWodqd4h1c9MgC0B0";

const REAL_ESTATE_GETALL_FLOW_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/546f2b72da524095ae6e0dd0cd6cf81e/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=4aoGW6OjT515BOUzOtv-aL_L46dfK3SmXyuGI3AYpps";

const REAL_ESTATE_DELETE_FLOW_URL="https://defaultad358c3362364cda92e747b5c2b8c1.3e.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/acb14d154d8e44df9d0db056b1056a4f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=mgbxAZPxiVZNHmtCNIWK4SmHVa04ONEY2b0PiJW5e-o";
var loginUserEmail = localStorage.getItem("loginEmail") || "";
var LoginUsername = localStorage.getItem("loginUserFullName") || "";
let realEstateId = 0;

let coApplicantIdMap = {
  1: 0,
  2: 0,
  3: 0
};


document.addEventListener("DOMContentLoaded", function () {
   document.getElementById("UserLoginname").innerText =
    `${localStorage.getItem("loginUserFullName")}`;
  
    if (localStorage.getItem("loginUserProfileImage")) {
    document.getElementById("UserProfileImage").src =
      "data:image/png;base64," + localStorage.getItem("loginUserProfileImage");
       

       
  } else {
   
    document.getElementById("UserProfileImage").src = "img/user-circle.png";
 
  }
    $("#ContactEmail").val(loginUserEmail);
const { FirstName, LastName } = splitFullName(LoginUsername);
    $("#ContactFirstName").val(FirstName);
        $("#ContactLastName").val(LastName);


 
$("#ContactEnquiryDate").val(new Date().toISOString().split("T")[0]);

   
     
  loadBrands();
  loadHearAboutBrand();
  loadBusinessExperience();
  getEnquiryByEmail();
  loadPersonalDetails();
  loadEmploymentDetails();
  getCoApplicantsByEmail(loginUserEmail);
  getFinancialData(loginUserEmail);
  getBusinessOpportunity(loginUserEmail);
  getOtherQuestion(loginUserEmail);
  getPreferredLocation(loginUserEmail);
  getAllRealEstate();



    // Hide by default
  $("#PersonalSocialSecurityDiv").hide();
  $("#SpouseNameDiv, #SpouseUSCitizenDiv").hide();

  // US Citizen change
  /* $("#PersonalUSCitizen").on("change", function () {
    if ($(this).val() === "Yes") {
      $("#PersonalSocialSecurityDiv").slideDown();
    } else {
      $("#PersonalSocialSecurityDiv").slideUp();
      $("#PersonalSocialSecurity").val("");
    }
  });

  // Marital Status change
  $("#PersonalMaritalStatus").on("change", function () {
    if ($(this).val() === "Married") {
      $("#SpouseNameDiv, #SpouseUSCitizenDiv","#SpouseBirthDateDiv","#SpousesocialsecurityDiv").slideDown();
    } else {
      $("#SpouseNameDiv, #SpouseUSCitizenDiv","#SpouseBirthDateDiv","#SpousesocialsecurityDiv").slideUp();
      $("#PersonalSpouseName, #PersonalSpouseUSCitizen").val("");
    }
  });*/


toggleSpouseFields($("#PersonalMaritalStatus").val());
  $("#PersonalMaritalStatus").on("change", function () {
  toggleSpouseFields($(this).val());
});
// Personal US Citizen
togglePersonalSSN($("#PersonalUSCitizen").val());

$("#PersonalUSCitizen").on("change", function () {
  togglePersonalSSN($(this).val());
});

// Spouse US Citizen
$("#PersonalSpouseUSCitizen").on("change", function () {
  toggleSpouseSSN($(this).val());
});




$("#ConvictedOfAnyOffence").on("change", function () {
  toggleConviction($(this).val());
});

$("#FiledForBankruptcy").on("change", function () {
  toggleBankruptcy($(this).val());
});
  // toggleConviction($("#ConvictedOfAnyOffence").val("Yes"));
  // toggleBankruptcy($("#FiledForBankruptcy").val("Yes"));

  /////Financial Section

  
$("#financial_tab1 input[type='number']").on("input", function () {
  sumInputs("#financial_tab1", "#IncometotalIncome");
});
$("#financial_tab2 input[type='number']").on("input", function () {
  sumInputs("#financial_tab2", "#ContingenttotalContingent");
});

$("#financial_tab3 input[type='number']").on("input", function () {
  sumInputs("#financial_tab3", "#AssetstotalAssets");
});

$("#financial_tab4 input[type='number']").on("input", function () {
  sumInputs("#financial_tab4", "#LiabilitiestotalLiabilities");
});
$("input[type='number']").on("input", calculateNetWorth);




$("#btnAddRealEstate").on("click", function () {
  addNewRealEstate();
});
});

function splitFullName(fullName) {
  if (!fullName) return { FirstName: "", LastName: "" };

  const parts = fullName.trim().split(/\s+/);

  return {
    FirstName: parts[0] || "",
    LastName: parts.length > 1 ? parts[parts.length - 1] : ""
  };
}

function togglePersonalSSN(value) {
  if (value === "Yes") {
    $("#PersonalSocialSecurityDiv").slideDown();
  } else {
    $("#PersonalSocialSecurityDiv").slideUp();
    $("#PersonalSocialSecurity").val("");
  }
}
function toggleSpouseSSN(value) {
  if (value === "Yes") {
    $("#PersonalSpouseSocialSecurityDiv").slideDown();
  } else {
    $("#PersonalSpouseSocialSecurityDiv").slideUp();
    $("#PersonalSpouseSocialSecurity").val("");
  }
}

function toggleSpouseFields(status) {
  if (status === "Married") {
    $("#SpouseNameDiv, #SpouseUSCitizenDiv, #SpouseBirthDateDiv, #PersonalSpouseSocialSecurityDiv").slideDown();
  } else {
    $("#SpouseNameDiv, #SpouseUSCitizenDiv, #SpouseBirthDateDiv, #PersonalSpouseSocialSecurityDiv").slideUp();
    $("#PersonalSpouseName, #PersonalSpouseUSCitizen, #PersonalSpouseBirthDate, #PersonalSpouseSocialSecurity").val("");
  }
}

function toggleConviction(value) {
  if (value === "Yes") {
    $("#ConvictedOfOffenceDetailsDiv").slideDown();
  } else {
    $("#ConvictedOfOffenceDetailsDiv").slideUp();
    $("#ConvictedOfOffenceDetails").val("");
  }
}
function toggleBankruptcy(value) {
  if (value === "Yes") {
    $("#BankruptcyFiledDateDiv, #BankruptcyDischargeDateDiv").slideDown();
  } else {
    $("#BankruptcyFiledDateDiv, #BankruptcyDischargeDateDiv").slideUp();
    $("#BankruptcyFiledDate, #BankruptcyDischargeDate").val("");
  }
}


function addNewRealEstate() {
  realEstateId = 0;

  // reset all inputs & selects
  $("#add_real_estate input, #add_real_estate select, #add_real_estate textarea").val("");

  //   set defaults
  $("#RealEstateDealType").val("Purchased");   // select Purchased
  $("#RealEstateGeneralContractorSelected").val("Yes"); // last option → Yes
  $("#RealEstatePurchaseOption").val("Yes"); // last option → Yes

  // open modal
 
}
function formatDateForInput(dateStr) {
  if (!dateStr) return "";
  return dateStr.split("T")[0];
}
function validatePositiveInteger(input) {
  // Remove anything except digits
  input.value = input.value.replace(/[^0-9]/g, "");

  // Remove leading zeros
  if (input.value.startsWith("0")) {
    input.value = input.value.replace(/^0+/, "");
  }
}
async function loadBrands() {
  try {
    const response = await fetch(BRANDS_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });

    if (!response.ok) throw new Error("API failed");

    let data = await response.json();
    console.log("Brands RAW:", data);

    if (!data.Brands) throw new Error("Brands not found");

    let brands = data.Brands;

    // If string → parse JSON
    if (typeof brands === "string") {
      brands = JSON.parse(brands);
    }

    if (!Array.isArray(brands)) {
      throw new Error("Brands is not an array");
    }

    bindBrands(brands);

  } catch (err) {
    console.error("Brand Load Error:", err);
     $("#shortAlertText").text("Failed to load brands");
      $("#shortAlert").modal("show");
   // alert("Failed to load brands");
  }
}
function bindBrands(brands) {
  const ddl = document.getElementById("ContactbrandsSelect");
  ddl.innerHTML = `<option value="">--Select Brand--</option>`;

  brands.forEach(b => {
    // Support object OR string
    const value = b.ID || b.Id || b;
    const text = b.Title || b.Name || b;

    const opt = document.createElement("option");
    opt.value = value;
    opt.text = text;

    ddl.appendChild(opt);
  });
}



async function loadHearAboutBrand() {
  try {
    const response = await fetch(HEAR_ABOUT_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });

    if (!response.ok) throw new Error("API call failed");

    let data = await response.json();
    console.log("HearAbout RAW:", data);

    if (!data.HearAboutBrand) {
      throw new Error("HearAboutBrand not found");
    }

    let items = data.HearAboutBrand;

    // If string → parse
    if (typeof items === "string") {
      items = JSON.parse(items);
    }

    if (!Array.isArray(items)) {
      throw new Error("HearAboutBrand is not an array");
    }

    bindHearAboutBrand(items);

  } catch (err) {
    console.error("HearAbout Load Error:", err);
      $("#shortAlertText").text("Failed to load options");
      $("#shortAlert").modal("show");
    //alert("Failed to load options");
  }
}


function bindHearAboutBrand(items) {
  const ddl = document.getElementById("ContactHearAboutbrand");
  ddl.innerHTML = `<option value="">--Select--</option>`;

  items.forEach(i => {
    const value = i.ID || i.Id || i;
    const text = i.Title || i.Name || i;

    const opt = document.createElement("option");
    opt.value = value;
    opt.text = text;

    ddl.appendChild(opt);
  });
}


async function loadBusinessExperience() {
  try {
    const response = await fetch(BUSINESS_EXPERIENCE_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });

    if (!response.ok) throw new Error("API call failed");

    let data = await response.json();
    console.log("BusinessExperience RAW:", data);

    if (!data.BusinessExperience) {
      throw new Error("BusinessExperience not found");
    }

    let items = data.BusinessExperience;

    // If response is string JSON → parse
    if (typeof items === "string") {
      items = JSON.parse(items);
    }

    if (!Array.isArray(items)) {
      throw new Error("BusinessExperience is not an array");
    }

    bindBusinessExperience(items);

  } catch (err) {
    console.error("BusinessExperience Load Error:", err);
     $("#shortAlertText").text("Failed to load Business Experience");
      $("#shortAlert").modal("show");
   // alert("Failed to load Business Experience");
  }
}


function bindBusinessExperience(items) {
  const ddl = document.getElementById("ContactBusinessExperience");
  ddl.innerHTML = `<option value="">--Select--</option>`;

  items.forEach(i => {
    const value = i.ID || i.Id || i;
    const text = i.Title || i.Name || i;

    const opt = document.createElement("option");
    opt.value = value;
    opt.text = text;

    ddl.appendChild(opt);
  });
}



/* =========================
   Contact Details
========================= */
async function ContactDetailsData(method,payload) {
  try {
    // build body dynamically
    let requestBody = {};

    if (method === "GET") {
      requestBody = {
        Email: payload.Email,
        Method: "GET"
      };
    } else if (method === "POST") {
      requestBody = {
        ...payload,   // send all fields
        Method: "POST"
      };
    }

    const response = await fetch(ContactDetails_API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      throw new Error("API failed");
    }

    const data = await response.json();
    handleEnquiryResponse(method, data);

    return data;

  } catch (err) {
    console.error("Enquiry Error:", err);
    throw err;
  }
}


/* =========================
   RESPONSE HANDLER
========================= */
function handleEnquiryResponse(method, data) {

  if (!data || !data.Status) return;

  if (data.Status === "No record found") {
       $("#shortAlertText").text("No record found");
      $("#shortAlert").modal("show");
   // alert("No record found");
    return;
  }

  if (data.Status === "Successfully Submitted") {
     $("#shortAlertText").text("Data submitted successfully");
      $("#shortAlert").modal("show");
   // alert("Data submitted successfully");
  
    return;
  }

  if (data.Status === "Success") {
    if (method === "GET") {
      bindEnquiryData(data);
    }
  //  alert("Success");
    return;
  }

   $("#shortAlertText").text(data.Status);
      $("#shortAlert").modal("show");
}

/* =========================
   BIND GET DATA
========================= */
function bindEnquiryData(data) {
  $("#ContactTopic").val(data.Topic || "");

  $("#ContactEnquiryDate").val(formatDateForInput(data.EnquiryDate || ""));
  $("#ContactFirstName").val(data.FirstName || "");
  $("#ContactMiddleName").val(data.MiddleName || "");
  $("#ContactLastName").val(data.LastName || "");
  $("#ContactMobilePhone").val(data.MobilePhone || "");
  $("#ContactHomePhone").val(data.HomePhone || "");
  $("#ContactBestTimeToContact").val(data.BestTimeToContact || "");
  $("#ContactbrandsSelect").val(data.BrandsApplyingFor || "");
  $("#ContactBusinessExperience").val(data.BusinessExperience || "");
  $("#ContactLocationRequested").val(data.LocationRequested || "");
  $("#ContactHearAboutbrand").val(data.HearAboutBrand || "");
  $("#ContactEmail").val(loginUserEmail);
}

/* =========================
   CALL GET
========================= */
function getEnquiryByEmail() {
  ContactDetailsData("GET", {
    Email: loginUserEmail,
  });
}

/* =========================
   CALL POST
========================= */
function submitEnquiry() {
    const firstName = $("#ContactFirstName").val().trim();
  const lastName = $("#ContactLastName").val().trim();
  const mobile = $("#ContactMobilePhone").val().trim();

  // ---- First Name Validation ----
  if (!firstName) {
    $("#shortAlertText").text("First Name is required");
      $("#shortAlert").modal("show");
    //alert("First Name is required");
    $("#ContactFirstName").focus();
    return;
  }
 
  // ---- Last Name Validation ----
  if (!lastName) {
      $("#shortAlertText").text("Last Name is required");
      $("#shortAlert").modal("show");
  //  alert("Last Name is required");
    $("#ContactLastName").focus();
    return;
  }

  

  // ---- Mobile Validation ----
  if (!mobile) {
     $("#shortAlertText").text("Mobile number is required");
      $("#shortAlert").modal("show");
   // alert("Mobile number is required");
    $("#ContactMobilePhone").focus();
    return;
  }

   
 
  const rawPayload = {
    Email: loginUserEmail,
    EmailAddress: $("#ContactEmail").val(),
    Topic: $("#ContactTopic").val(),
   EnquiryDate: new Date($("#ContactEnquiryDate").val()).toISOString(), // keep as yyyy-MM-dd
    FirstName: $("#ContactFirstName").val(),
    MiddleName: $("#ContactMiddleName").val(),
    LastName: $("#ContactLastName").val(),
    MobilePhone: $("#ContactMobilePhone").val(),
    HomePhone: $("#ContactHomePhone").val(),
    BestTimeToContact: $("#ContactBestTimeToContact").val(),
    BrandsApplyingFor: $("#ContactbrandsSelect").val(),
    BusinessExperience: $("#ContactBusinessExperience").val(),
    LocationRequested: $("#ContactLocationRequested").val(),
    HearAboutBrand: $("#ContactHearAboutbrand").val()
  };

//   const allowEmptyKeys = [
//   "BrandsApplyingFor",
//   "BusinessExperience",
//   "HearAboutBrand"
// ];

// const payload = Object.fromEntries(
//   Object.entries(rawPayload).filter(([key, value]) =>
//     allowEmptyKeys.includes(key) ||
//     (
//       value !== null &&
//       value !== undefined &&
//       value !== "" &&
//       !(typeof value === "number" && isNaN(value))
//     )
//   )
// );

  const payload = Object.fromEntries(
    Object.entries(rawPayload).filter(([_, value]) =>
      value !== null &&
      value !== undefined &&
      value !== "" &&
      !(typeof value === "number" && isNaN(value))
    )
  );

  // Convert number AFTER filtering
  if (payload.LocationRequested) {
    payload.LocationRequested = parseInt(payload.LocationRequested, 10);
  }

  ContactDetailsData("POST", payload);
 

}







/////////////PERSONAL DETAIL SECTION



async function PersonalDetailsAPI(payload, method) {
  try {
    const body = method === "GET"
      ? {
          Email: payload.Email,
          Method: "GET"
        }
      : {
          ...payload,
          Method: "POST"
        };

    const response = await fetch(PersonalDetails_API_URL, {
      method: "POST", // Always POST for Power Automate
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      throw new Error("API failed");
    }

    return await response.json();

  } catch (err) {
    console.error("Personal Details Error:", err);
    throw err;
  }
}


function submitPersonalDetails() {

  const rawPayload = {
    Email: loginUserEmail,
    Gender: $("#PersonalGender").val(),
    DateOfBirth: dateOrNull($("#PersonalDateOfBirth").val()), // yyyy-MM-dd
    HomeOwnership: $("#PersonalHomeOwnership").val(),
    USCitizen: $("#PersonalUSCitizen").val(), // Yes / No
    SocialSecurity: $("#PersonalSocialSecurity").val(),
    MaritalStatus: $("#PersonalMaritalStatus").val(),
    SpouseName: $("#PersonalSpouseName").val(),
    SpouseBirthDate: dateOrNull($("#PersonalSpouseBirthDate").val()), // yyyy-MM-dd
    SpouseUSCitizen: $("#PersonalSpouseUSCitizen").val(), // Yes / No
    SpouseSocilSecurity: $("#PersonalSpouseSocialSecurity").val(),
    FulltimeBusiness: $("#PersonalFulltimeBusiness").val() // Yes / No
  };

  //   Remove empty / null fields
  let payload = Object.fromEntries(
    Object.entries(rawPayload).filter(([_, value]) =>
      value !== null &&
      value !== undefined &&
      value !== ""
    )
  );

  // ✅ Convert Yes/No → Boolean
  const booleanFields = [
    "USCitizen",
    "SpouseUSCitizen",
    "FulltimeBusiness"
  ];

  booleanFields.forEach(field => {
    if (payload[field] !== undefined) {
      payload[field] = payload[field].toLowerCase() === "yes";
    }
  });

  

  PersonalDetailsAPI(payload, "POST")
    .then(data => {
      if (data.Status === "Successfully Submitted" || data.Status === "Success") {
             $("#shortAlertText").text("Personal details saved successfully");
      $("#shortAlert").modal("show");
       // alert("Personal details saved successfully");
      } else {
          $("#shortAlertText").text(data.Status);
      $("#shortAlert").modal("show");
       // alert(data.Status);
      }
    })
    .catch(() => {
       $("#shortAlertText").text("Something went wrong. Please try again.");
      $("#shortAlert").modal("show");
     // alert("Something went wrong. Please try again.");
    });
}



function loadPersonalDetails() {
  const email = loginUserEmail;
  if (!email) return;

  PersonalDetailsAPI({ Email: email }, "GET")
    .then(data => {
       console.log(data);
      if (data.Status === "Success") {
        console.log("1");
        bindPersonalDetails(data);
      }
    })
    .catch(err => console.error(err));
}

function bindPersonalDetails(data) {
  $("#PersonalGender").val(data.Gender || "");
  $("#PersonalDateOfBirth").val(data.DateOfBirth || "");
  $("#PersonalHomeOwnership").val(data.HomeOwnership || "");
  $("#PersonalUSCitizen").val(toYesNo(data.USCitizen));
  $("#PersonalSocialSecurity").val(data.SocialSecurity || "");
  $("#PersonalMaritalStatus").val(data.MaritalStatus || "");
  $("#PersonalSpouseName").val(data.SpouseName || "");
  $("#PersonalSpouseBirthDate").val(data.SpouseBirthDate || "");
  $("#PersonalSpouseUSCitizen").val(toYesNo(data.SpouseUSCitizen));
  $("#PersonalSpouseSocialSecurity").val(data.SpouseSocilSecurity || "");
  $("#PersonalFulltimeBusiness").val(toYesNo(data.FulltimeBusiness));


  toggleSpouseFields(data.MaritalStatus);
 

}





/////////EMPLOYMENT SECTION


async function EmploymentDetailsAPI(payload, method) {
  try {
    const body =
      method === "GET"
        ? { Email: payload.Email, Method: "GET" }
        : { ...payload, Method: "POST" };

    const response = await fetch(EmploymentDetails_API_URL, {
      method: "POST", // Power Automate always POST
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      throw new Error("API failed");
    }

    return await response.json();

  } catch (err) {
    console.error("Employment Details Error:", err);
    throw err;
  }
}


function submitEmploymentDetails() {

 const rawPayload = {
    Email: loginUserEmail,
    PresentEmployer: $("#EmploymentPresentEmployer").val(),
    JobTitle: $("#EmploymentJobTitle").val(),
    EmploymentStartedDate: dateOrNull($("#EmploymentStartedDate").val()), // yyyy-MM-dd
    WorkAddress: $("#EmploymentWorkAddress").val(),
    WorkHoursPerWeek: $("#EmploymentWorkHoursPerWeek").val(),
    WorkPhone: $("#EmploymentWorkPhone").val(),
    WorkPhoneExtension: $("#EmploymentWorkPhoneExtension").val(),
    AllowCallYouAtWork: $("#EmploymentAllowCallYouAtWork").val(), // Yes/No
    AnnualSalary: $("#EmploymentAnnualSalary").val(),
    YourResponsibilities: $("#EmploymentYourResponsibilities").val(),
    SelfEmployed: $("#EmploymentSelfEmployed").val() // Yes/No
  };

  //   Remove empty / null values
  let payload = Object.fromEntries(
    Object.entries(rawPayload).filter(([_, value]) =>
      value !== null &&
      value !== undefined &&
      value !== ""
    )
  );
 //  Convert Yes/No to boolean
  if (payload.AllowCallYouAtWork !== undefined) {
    payload.AllowCallYouAtWork =
      payload.AllowCallYouAtWork.toLowerCase() === "yes";
  }

  if (payload.SelfEmployed !== undefined) {
    payload.SelfEmployed =
      payload.SelfEmployed.toLowerCase() === "yes";
  }

  //   Convert numbers
  if (payload.WorkHoursPerWeek) {
    payload.WorkHoursPerWeek = parseInt(payload.WorkHoursPerWeek, 10);
  }

  if (payload.AnnualSalary) {
    payload.AnnualSalary = parseFloat(payload.AnnualSalary);
  }

  EmploymentDetailsAPI(payload, "POST")
    .then(data => {
      if (data.Status === "Successfully Submitted" || data.Status === "Success") {
         $("#shortAlertText").text("Employment details saved successfully");
      $("#shortAlert").modal("show");
       // alert("Employment details saved successfully");
      } else {
         $("#shortAlertText").text(data.Status);
      $("#shortAlert").modal("show");
       // alert(data.Status);
      }
    })
    .catch(() => {
         $("#shortAlertText").text("Something went wrong. Please try again.");
      $("#shortAlert").modal("show");
     // alert("Something went wrong. Please try again.");
    });
}


function loadEmploymentDetails() {
  const email = loginUserEmail;
  if (!email) return;

  EmploymentDetailsAPI({ Email: email }, "GET")
    .then(data => {
      console.log(data);
      if (data.Status === "Success") {
        console.log("2");
        bindEmploymentDetails(data);
      }
    })
    .catch(err => console.error(err));
}


function bindEmploymentDetails(data) {
  $("#EmploymentPresentEmployer").val(data.PresentEmployer || "");
  $("#EmploymentJobTitle").val(data.JobTitle || "");
  $("#EmploymentStartedDate").val(data.EmploymentStartedDate || "");
  $("#EmploymentWorkAddress").val(data.WorkAddress || "");
  $("#EmploymentWorkHoursPerWeek").val(data.WorkHoursPerWeek || "");
  $("#EmploymentWorkPhone").val(data.WorkPhone || "");
  $("#EmploymentWorkPhoneExtension").val(data.WorkPhoneExtension || "");
  $("#EmploymentAllowCallYouAtWork").val(toYesNo(data.AllowCallYouAtWork));
  $("#EmploymentAnnualSalary").val(data.AnnualSalary || "");
  $("#EmploymentYourResponsibilities").val(data.YourResponsibilities || "");
  $("#EmploymentSelfEmployed").val(toYesNo(data.SelfEmployed));


 
 }


function toYesNo(value) {
  if (value === true || value === "true" || value === "True") return "Yes";
  if (value === false || value === "false" || value === "False") return "No";
  return "";
}



///Co-Applicant Section

function getCoApplicantsByEmail(email) {
debugger;
  const payload = {
    Email: email
  };

  $.ajax({
    url: CO_APPLICANT_GET_FLOW_URL,
    type: "POST",                     // Flow trigger is POST
    contentType: "application/json",
    data: JSON.stringify(payload),

    success: function (res) {

       if (typeof res === "string") {
        res = JSON.parse(res);
      }

      if (res.Status === "No record found") {
        console.log("No co-applicant record found");
        return;
      }

      if (res.Status === "Success" && Array.isArray(res.CoApplicants)) {
        bindCoApplicants(res.CoApplicants);
      }
    },

    error: function () {
         $("#shortAlertText").text("Something went wrong. Please try again");
      $("#shortAlert").modal("show");
     // alert("Something went wrong. Please try again");
    }
  });
}

 
function bindCoApplicants(coApplicants) {

  window.coApplicantIdMap = {}; // global map for update

  coApplicants.forEach((item, index) => {

    // Sequence handling
    const seq = item.SequenceNo && item.SequenceNo.trim()
      ? item.SequenceNo.trim()
      : String(index + 1);

    // Store Id (0 if first time)
    coApplicantIdMap[seq] = item.Id ? Number(item.Id) : 0;

    console.log("Binding CoApplicant seq:", seq, item);

    const setVal = (cls, val) => {
      const el = $(`${cls}[data-seq="${seq}"]`);
      if (el.length) {
        el.val(val || "");
      } else {
        console.warn(`Missing element: ${cls}[data-seq="${seq}"]`);
      }
    };

    setVal(".firstName", item.FirstName);
    setVal(".middleName", item.MiddleName);
    setVal(".lastName", item.LastName);
    setVal(".role", item.Role);
    setVal(".address", item.Address);
    setVal(".city", item.City);
    setVal(".state", item.State);
    setVal(".zip", item.Zip);
    setVal(".country", item.Country);
    setVal(".phone", item.Phone);
    setVal(".email", item.EmailAddress);
  });
}





function buildCoApplicantPayload() {

  const coApplicants = [];

  for (let seq = 1; seq <= 3; seq++) {

    const firstName = $(`.firstName[data-seq="${seq}"]`).val()?.trim();

    //   Skip empty co-applicant blocks
    if (!firstName) continue;

    coApplicants.push({
      Id: coApplicantIdMap?.[seq] || 0,   // 0 for first time
      SequenceNo: seq,

      FirstName: firstName,
      MiddleName: $(`.middleName[data-seq="${seq}"]`).val() || "",
      LastName: $(`.lastName[data-seq="${seq}"]`).val() || "",
      Role: $(`.role[data-seq="${seq}"]`).val() || "",
      Address: $(`.address[data-seq="${seq}"]`).val() || "",
      City: $(`.city[data-seq="${seq}"]`).val() || "",
      State: $(`.state[data-seq="${seq}"]`).val() || "",
      Zip: $(`.zip[data-seq="${seq}"]`).val() || "",
      Country: $(`.country[data-seq="${seq}"]`).val() || "",
      Phone: $(`.phone[data-seq="${seq}"]`).val() || "",
      EmailAddress: $(`.email[data-seq="${seq}"]`).val() || ""
    });
  }

  return coApplicants;
}





function submitCoApplicants() {

  const payload = {
    Email: localStorage.getItem("loginEmail"),
    CoApplicants: buildCoApplicantPayload()
  };

  $.ajax({
    url: CO_APPLICANT_POST_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),

    success: function (res) {
      if (typeof res === "string") res = JSON.parse(res);

      if (res.Status === "Successfully Submitted") {
         $("#shortAlertText").text("Co-applicants saved successfully");
      $("#shortAlert").modal("show");
        //alert("Co-applicants saved successfully");
      }else {
          $("#shortAlertText").text(res.Status);
      $("#shortAlert").modal("show");
       // alert(data.Status);
      }
    },
    error: function () {
       $("#shortAlertText").text("Something went wrong");
      $("#shortAlert").modal("show");
     // alert("Something went wrong");
    }
  });
}




///////Financial Section 


function sumInputs(containerSelector, totalInputSelector) {
  let total = 0;

  $(`${containerSelector} input[type="number"]:not([disabled])`).each(function () {
    const val = parseFloat($(this).val());
    if (!isNaN(val)) total += val;
  });

  $(totalInputSelector).val(total);
}

function calculateNetWorth() {
  const assets = parseFloat($("#AssetstotalAssets").val()) || 0;
  const liabilities = parseFloat($("#LiabilitiestotalLiabilities").val()) || 0;
  const contingent = parseFloat($("#ContingenttotalContingent").val()) || 0;

  $("#netWorth").val(assets - (liabilities + contingent));
}

function cleanPayload(obj) {
  return Object.fromEntries(
    Object.entries(obj).filter(([_, v]) => v !== undefined)
  );
}


function getFinancialData(loginUserEmail) {

  const payload = {
    Method: "GET",
    Email: loginUserEmail
  };

  $.ajax({
    url: FINANCIAL_POST_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {
       console.log(res);
        // Convert string → object if needed
  if (typeof res === "string") {
    res = JSON.parse(res);
  }

      if (res.Status === "No record found") {
        console.log("No financial data found");
        return;
      }

      if (res.Status === "Success") {

        //  Income
        $("#Incomesalary").val(res.IncomeSalary || "");
        $("#IncomespouseIncome").val(res.IncomeSpouse || "");
        $("#Incomebonus").val(res.BonusesCommissions || "");
        $("#Incomeinterest").val(res.InterestDividend || "");
        $("#IncomerealEstateIncome").val(res.RealEstateIncome || "");
        $("#Incomeinvestments").val(res.Investment || "");
        $("#IncomebusinessIncome").val(res.BusinessIncome || "");
        $("#IncomeotherIncome").val(res.OtherIncome || "");
        $("#IncometotalIncome").val(res.TotalIncome || "");

        // Contingent
        $("#ContingenthasContingent").val(toYesNo(res.HaveContingentLiabilities));
        $("#ContingentloanCosign").val(res.LoanCoSignature || "");
        $("#ContingentlegalJudgement").val(res.LegalJudgement || "");
        $("#ContingentotherDebt").val(res.OtherSpecialDebt || "");
        $("#ContingentincomeTaxes").val(res.IncomeTaxes || "");
        $("#ContingenttotalContingent").val(res.TotalContingentLiabilities || "");

        // Assets
        $("#Assetscash").val(res.CashInHand || "");
        $("#Assetssecurities").val(res.MarketableSecurities || "");
        $("#AssetsassetRealEstate").val(res.RealEstateValue || "");
        $("#Assetsreceivable").val(res.AccountReceivable || "");
        $("#AssetsbusinessHoldings").val(res.BusinessHoldings || "");
        $("#AssetslifeInsurance").val(res.LifeInsurance || "");
        $("#Assetsretirement").val(res.RetirementSavingAccount || "");
        $("#AssetspersonalProperty").val(res.PersonalProperty || "");
        $("#AssetsotherAssets").val(res.OtherAssets || "");
        $("#AssetstotalAssets").val(res.TotalAssets || "");

        //  Liabilities
        $("#LiabilitiesnotesPayable").val(res.CashPayable || "");
        $("#Liabilitiesmortgages").val(res.Mortgages || "");
        $("#LiabilitiesaccountsPayable").val(res.AccountsPayable || "");
        $("#LiabilitiesbillsDue").val(res.AccountsBillDue || "");
        $("#LiabilitiesunpaidTaxes").val(res.UnpaidTaxes || "");
        $("#LiabilitiesinsuranceLoans").val(res.LoansOnLifeInsurance || "");
        $("#LiabilitiesotherLiabilities").val(res.OtherLiabilities || "");
        $("#LiabilitiestotalLiabilities").val(res.TotalLiabilities || "");

        //  Net Worth
        $("#netWorth").val(res.TotalNetWorth || "");
      }
    },
    error: () => alert("Something went wrong while fetching data")
  });
}

function numOrUndefined(val) {
  if (val === null || val === undefined || val === "") return undefined;

  const n = Number(val);
  return isNaN(n) ? undefined : n; // allows 1, 1.3, 0, etc.
}
 function submitFinancial() {

  const payload = cleanPayload({
  Method: "POST",
  Email: localStorage.getItem("loginEmail"),

  // Income
  IncomeSalary: numOrUndefined($("#Incomesalary").val()),
  IncomeSpouse: numOrUndefined($("#IncomespouseIncome").val()),
  BonusesCommissions: numOrUndefined($("#Incomebonus").val()),
  InterestDividend: numOrUndefined($("#Incomeinterest").val()),
  RealEstateIncome: numOrUndefined($("#IncomerealEstateIncome").val()),
  Investment: numOrUndefined($("#Incomeinvestments").val()),
  BusinessIncome: numOrUndefined($("#IncomebusinessIncome").val()),
  OtherIncome: numOrUndefined($("#IncomeotherIncome").val()),
  TotalIncome: numOrUndefined($("#IncometotalIncome").val()),

  // Contingent Liabilities
  HaveContingentLiabilities: yesNoToBool($("#ContingenthasContingent").val()),
  LoanCoSignature: numOrUndefined($("#ContingentloanCosign").val()),
  LegalJudgement: numOrUndefined($("#ContingentlegalJudgement").val()),
  OtherSpecialDebt: numOrUndefined($("#ContingentotherDebt").val()),
  IncomeTaxes: numOrUndefined($("#ContingentincomeTaxes").val()),
  TotalContingentLiabilities: numOrUndefined($("#ContingenttotalContingent").val()),

  // Assets
  CashInHand: numOrUndefined($("#Assetscash").val()),
  MarketableSecurities: numOrUndefined($("#Assetssecurities").val()),
  RealEstateValue: numOrUndefined($("#AssetsassetRealEstate").val()),
  AccountReceivable: numOrUndefined($("#Assetsreceivable").val()),
  BusinessHoldings: numOrUndefined($("#AssetsbusinessHoldings").val()),
  LifeInsurance: numOrUndefined($("#AssetslifeInsurance").val()),
  RetirementSavingAccount: numOrUndefined($("#Assetsretirement").val()),
  PersonalProperty: numOrUndefined($("#AssetspersonalProperty").val()),
  OtherAssets: numOrUndefined($("#AssetsotherAssets").val()),
  TotalAssets: numOrUndefined($("#AssetstotalAssets").val()),

  // Liabilities
  CashPayable: numOrUndefined($("#LiabilitiesnotesPayable").val()),
  Mortgages: numOrUndefined($("#Liabilitiesmortgages").val()),
  AccountsPayable: numOrUndefined($("#LiabilitiesaccountsPayable").val()),
  AccountsBillDue: numOrUndefined($("#LiabilitiesbillsDue").val()),
  UnpaidTaxes: numOrUndefined($("#LiabilitiesunpaidTaxes").val()),
  LoansOnLifeInsurance: numOrUndefined($("#LiabilitiesinsuranceLoans").val()),
  OtherLiabilities: numOrUndefined($("#LiabilitiesotherLiabilities").val()),
  TotalLiabilities: numOrUndefined($("#LiabilitiestotalLiabilities").val()),

  // Net Worth
  TotalNetWorth: numOrUndefined($("#netWorth").val())
});


 $.ajax({
  url: FINANCIAL_POST_FLOW_URL,
  type: "POST",
  contentType: "application/json",
  data: JSON.stringify(payload),
  success: function (res) {

    //  Ensure JSON
    if (typeof res === "string") {
      try {
        res = JSON.parse(res);
      } catch (e) {
            $("#shortAlertText").text("Unexpected response from server");
      $("#shortAlert").modal("show");
        //alert("Unexpected response from server");
        return;
      }
    }

    //  Status-based alerts
    if (res.Status === "Successfully Submitted" ) {
          $("#shortAlertText").text("Data saved successfully");
      $("#shortAlert").modal("show");
     // alert("Successfully Submitted");
    } else {
     // alert(res.Status || "Something went wrong. Please try again");
          $("#shortAlertText").text(res.Status || "Something went wrong. Please try again");
      $("#shortAlert").modal("show");
    }
  },
  error: function () {
       $("#shortAlertText").text("Something went wrong. Please try again");
      $("#shortAlert").modal("show")
   // alert("Something went wrong. Please try again");
  }
});

}



////// RELATED QUESTION SECTION


function numOrUndefinedQUESTION(val) {
  if (val === "" || val === null || val === undefined) return undefined;
  const n = Number(val);
  return isNaN(n) ? undefined : n;
}

function cleanPayloadQUESTION(obj) {
  return Object.fromEntries(
    Object.entries(obj).filter(([_, v]) => v !== undefined && v !== "")
  );
}


function submitBusinessOpportunity() {

  const payload = cleanPayloadQUESTION({
    Method: "POST",
    Email: localStorage.getItem("loginEmail"),

    HowFinanceYourFranchise: $("#HowFinanceYourFranchise").val(),
    HaveAPartner: yesNoToBool($("#HaveAPartner").val()),
    WhenWillBeReadyToInvest: $("#WhenWillBeReadyToInvest").val(),
    OtherFranchiseOpportunity: $("#OtherFranchiseOpportunity").val(),
    SkillsForYourSuccess: $("#SkillsForYourSuccess").val(),
    YourInterestPeriodToOwning: $("#YourInterestPeriodToOwning").val(),
    DailyOperationResponsibility: $("#DailyOperationResponsibility").val(),

    CashAvailableForInvestment: numOrUndefinedQUESTION($("#CashAvailableForInvestment").val()),
    YourPersonalGoals: $("#YourPersonalGoals").val(),

    ApprovedForFinancing: yesNoToBool($("#ApprovedForFinancing").val()),
    AmountApproved: numOrUndefinedQUESTION($("#AmountApproved").val()),

    SoleIncomeSource: yesNoToBool($("#SoleIncomeSource").val()),
    AnyLawsuitAsDefendant: yesNoToBool($("#AnyLawsuitAsDefendant").val()),
    ConvictedOfAFelony: yesNoToBool($("#ConvictedOfAFelony").val()),
    ConvictedOfAnyOffence: yesNoToBool($("#ConvictedOfAnyOffence").val()),
    ConvictedOfOffenceDetails: $("#ConvictedOfOffenceDetails").val(),

    FiledForBankruptcy: yesNoToBool($("#FiledForBankruptcy").val()),
    BankruptcyFiledDate: dateOrNull($("#BankruptcyFiledDate").val()),
    BankruptcyDischargeDate: dateOrNull($("#BankruptcyDischargeDate").val()),

    BusinessOpportunityQuestion1: $("#BusinessOpportunityQuestion1").val(),
    BusinessOpportunityQuestion2: $("#BusinessOpportunityQuestion2").val(),
    BusinessOpportunityQuestion3: $("#BusinessOpportunityQuestion3").val()
  });

  $.ajax({
    url: BUSINESS_POST_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {
      if (typeof res === "string") res = JSON.parse(res);

      if (res.Status === "Successfully Submitted") {
          $("#shortAlertText").text("Data saved successfully");
      $("#shortAlert").modal("show");
        //alert("Successfully Submitted");
      } else {
         $("#shortAlertText").text(res.Status || "Something went wrong");
         $("#shortAlert").modal("show");
       // alert(res.Status || "Something went wrong");
      }
    },
    error: function () {
       $("#shortAlertText").text("Something went wrong. Please try again");
         $("#shortAlert").modal("show");
     // alert("Something went wrong. Please try again");
    }
  });
}

// function yesNoToBool(val) {
//   return val === "Yes";
// }
function yesNoToBool(val) {
  if (!val) return false;

  const v = val.toString().trim().toLowerCase();
  if (v === "yes") return true;
  if (v === "no") return false;

  console.warn("Unexpected Yes/No value:", val);
  return false;
}


function dateOrNull(val) {
  return val ? new Date(val) : "";
}


function getBusinessOpportunity(email) {
  debugger;
const payload = {
    Method: "GET",
    Email: email
  };

  $.ajax({
    url: BUSINESS_POST_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {
 
 

      // Ensure JSON
      if (typeof res === "string") {
        try {
          res = JSON.parse(res);
        } catch {
          console.error("Invalid JSON response", res);
          return;
        }
      }

      if (res.Status === "No record found") {
        console.log("No business opportunity data found");
        return;
      }

      // Bind data
      if (res.Status === "Success") {
      $("#HowFinanceYourFranchise").val(res.HowFinanceYourFranchise || "");
      $("#HaveAPartner").val(toYesNo(res.HaveAPartner));
      $("#WhenWillBeReadyToInvest").val(res.WhenWillBeReadyToInvest || "");
      $("#OtherFranchiseOpportunity").val(res.OtherFranchiseOpportunity || "");
      $("#SkillsForYourSuccess").val(res.SkillsForYourSuccess || "");
      $("#YourInterestPeriodToOwning").val(res.YourInterestPeriodToOwning || "");
      $("#DailyOperationResponsibility").val(res.DailyOperationResponsibility || "");
      $("#CashAvailableForInvestment").val(res.CashAvailableForInvestment || "");
      $("#YourPersonalGoals").val(res.YourPersonalGoals || "");
      $("#ApprovedForFinancing").val(toYesNo(res.ApprovedForFinancing));
      $("#AmountApproved").val(res.AmountApproved || "");
      $("#SoleIncomeSource").val(toYesNo(res.SoleIncomeSource));
      $("#AnyLawsuitAsDefendant").val(toYesNo(res.AnyLawsuitAsDefendant));
      $("#ConvictedOfAFelony").val(toYesNo(res.ConvictedOfAFelony));
      $("#ConvictedOfAnyOffence").val(toYesNo(res.ConvictedOfAnyOffence));
      $("#ConvictedOfOffenceDetails").val(toYesNo(res.ConvictedOfOffenceDetails));
      $("#FiledForBankruptcy").val(toYesNo(res.FiledForBankruptcy));
      $("#BankruptcyFiledDate").val(res.BankruptcyFiledDate || "");
      $("#BankruptcyDischargeDate").val(res.BankruptcyDischargeDate || "");
      $("#BusinessOpportunityQuestion1").val(res.BusinessOpportunityQuestion1 || "");
      $("#BusinessOpportunityQuestion2").val(res.BusinessOpportunityQuestion2 || "");
      $("#BusinessOpportunityQuestion3").val(res.BusinessOpportunityQuestion3 || "");
      toggleConviction(toYesNo(res.ConvictedOfAnyOffence));
      toggleBankruptcy(toYesNo(res.FiledForBankruptcy));
      }
    },
    error: function () {
          $("#shortAlertText").text("Something went wrong while fetching business opportunity data");
      $("#shortAlert").modal("show");
     // alert("Something went wrong while fetching business opportunity data");
    }
  });
}




////Other Question Section


function submitOtherQuestion() {

  const payload = cleanPayloadQUESTION({
    Method: "POST",
    Email: localStorage.getItem("loginEmail"),

    OtherFacts: $("#OtherFacts").val(),
    GoalsandAspirations: $("#GoalsandAspirations").val(),
    OtherInformation: $("#OtherInformation").val(),
    PersonalPersonalityStyle: $("#PersonalPersonalityStyle").val(),
    ReasonForTimeFrameChoice: $("#ReasonForTimeFrameChoice").val()
  });

  $.ajax({
    url: OTHER_QUESTION_POST_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {
      if (typeof res === "string") res = JSON.parse(res);

      if (res.Status === "Successfully Submitted") {
         $("#shortAlertText").text("Data saved successfully");
      $("#shortAlert").modal("show");
       // alert("Successfully Submitted");
      } else {
        $("#shortAlertText").text(res.Status || "Something went wrong");
      $("#shortAlert").modal("show");
        //alert(res.Status || "Something went wrong");
      }
    },
    error: function () {
       $("#shortAlertText").text("Something went wrong. Please try again");
      $("#shortAlert").modal("show");
      //alert("Something went wrong. Please try again");
    }
  });
}




function getOtherQuestion(email) {
const payload = {
    Method: "GET",
    Email: email
  };

  $.ajax({
    url: OTHER_QUESTION_POST_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {
 
 

      // Ensure JSON
      if (typeof res === "string") {
        try {
          res = JSON.parse(res);
        } catch {
          console.error("Invalid JSON response", res);
          return;
        }
      }

      if (res.Status === "No record found") {
        console.log("No business opportunity data found");
        return;
      }
if (res.Status === "Success") {
     $("#OtherFacts").val(res.OtherFacts || "");
      $("#GoalsandAspirations").val(res.GoalsandAspirations || "");
      $("#OtherInformation").val(res.OtherInformation || "");
      $("#PersonalPersonalityStyle").val(res.PersonalPersonalityStyle || "");
      $("#ReasonForTimeFrameChoice").val(res.ReasonForTimeFrameChoice || "");
}
    },
    error: function () {
         $("#shortAlertText").text("Something went wrong while fetching business opportunity data");
      $("#shortAlert").modal("show");
      // alert("Something went wrong while fetching business opportunity data");
    }
  });
}




////////////////Preffered Location Section

function submitPreferredLocation() {

  const payload = cleanPayloadQUESTION({
    Method: "POST",
    Email: localStorage.getItem("loginEmail"),

    PreferredAddress1: $("#PreferredAddress1").val(),
    PreferredCity1: $("#PreferredCity1").val(),
    PreferredState1: $("#PreferredState1").val(),
    PreferredZip1: $("#PreferredZip1").val(),
    PreferredCountry1: $("#PreferredCountry1").val(),

    PreferredAddress2: $("#PreferredAddress2").val(),
    PreferredCity2: $("#PreferredCity2").val(),
    PreferredState2: $("#PreferredState2").val(),
    PreferredZip2: $("#PreferredZip2").val(),
    PreferredCountry2: $("#PreferredCountry2").val()
  });

  $.ajax({
    url: PREFERRED_LOCATION_POST_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {
      if (typeof res === "string") res = JSON.parse(res);

      if (res.Status === "Successfully Submitted") {
          $("#shortAlertText").text("Data saved successfully");
      $("#shortAlert").modal("show");
        //alert("Successfully Submitted");
      } else {
               $("#shortAlertText").text(res.Status || "Something went wrong");
      $("#shortAlert").modal("show");
        //alert(res.Status || "Something went wrong");
      }
    },
    error: function () {
          $("#shortAlertText").text("Something went wrong. Please try again");
      $("#shortAlert").modal("show");
     // alert("Something went wrong. Please try again");
    }
  });
}



function getPreferredLocation(email) {
const payload = {
    Method: "GET",
    Email: email
  };

  $.ajax({
    url: PREFERRED_LOCATION_POST_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {
 

      if (typeof res === "string") res = JSON.parse(res);
      if (res.Status === "No record found") return;

      if (res.Status === "Success") {

      $("#PreferredAddress1").val(res.PreferredAddress1 || "");
      $("#PreferredCity1").val(res.PreferredCity1 || "");
      $("#PreferredState1").val(res.PreferredState1 || "");
      $("#PreferredZip1").val(res.PreferredZip1 || "");
      $("#PreferredCountry1").val(res.PreferredCountry1 || "");

      $("#PreferredAddress2").val(res.PreferredAddress2 || "");
      $("#PreferredCity2").val(res.PreferredCity2 || "");
      $("#PreferredState2").val(res.PreferredState2 || "");
      $("#PreferredZip2").val(res.PreferredZip2 || "");
      $("#PreferredCountry2").val(res.PreferredCountry2 || "");
      }
    },
    error: function () {
      console.log("Failed to fetch preferred location data");
    }
  });
}




///////REAL STATE SECTION


function RealnumOrUndefined(val) {
  if (val === "" || val === null || isNaN(val)) return undefined;
  return Number(val);
}

function RealstrOrUndefined(val) {
  return val && val.trim() !== "" ? val.trim() : undefined;
}

function RealdateOrUndefined(val) {
  if (!val) return undefined;
  const d = new Date(val);
  return isNaN(d.getTime()) ? undefined : d.toISOString();
}

function validateRequired(fields) {
  for (let f of fields) {
    if (!f.value || f.value.trim() === "") {
        $("#shortAlertText").text(`Please enter ${f.name}`);
      $("#shortAlert").modal("show");
     // alert(`Please enter ${f.name}`);
      f.el.focus();
      return false;
    }
  }
  return true;
}

function validateRealEstateForm() {
  return validateRequired([
    { name: "Deal Type", value: $("#RealEstateDealType").val(), el: $("#RealEstateDealType") },
    { name: "PresentValue", value: $("#RealEstatePresentValue").val(), el: $("#RealEstatePresentValue") },
    { name: "OriginalCost", value: $("#RealEstateOriginalCost").val(), el: $("#RealEstateOriginalCost") },
    { name: "Address", value: $("#RealEstateAddress").val(), el: $("#RealEstateAddress") },
    { name: "PurchasedDate", value: $("#RealEstatePurchasedDate").val(), el: $("#RealEstatePurchasedDate") }
  ]);
}
function submitRealEstate() {

  if (!validateRealEstateForm()) return;

  const payload = {
    Method: "POST", // Same for Add & Update
    Email: localStorage.getItem("loginEmail"),
    Id: realEstateId || 0,

    DealType: RealstrOrUndefined($("#RealEstateDealType").val()),
    PresentValue: RealnumOrUndefined($("#RealEstatePresentValue").val()),
    OriginalCost: RealnumOrUndefined($("#RealEstateOriginalCost").val()),

    RealEstateAddress: RealstrOrUndefined($("#RealEstateAddress").val()),
    SiteStreet1: RealstrOrUndefined($("#RealEstateSiteStreet1").val()),
    SiteStreet2: RealstrOrUndefined($("#RealEstateSiteStreet2").val()),
    SiteCity: RealstrOrUndefined($("#RealEstateSiteCity").val()),
    State: RealstrOrUndefined($("#RealEstateState").val()),
    Country: RealstrOrUndefined($("#RealEstateCountry").val()),

    ParkingSpaces: RealstrOrUndefined($("#RealEstateParkingSpaces").val()),
    PurchaseOption: RealstrOrUndefined($("#RealEstatePurchaseOption").val()),

    BuildingSize: RealstrOrUndefined($("#RealEstateBuildingSize").val()),
    BuildingLength: RealstrOrUndefined($("#RealEstateBuildingLength").val()),
    BuildingBreadth: RealstrOrUndefined($("#RealEstateBuildingBreadth").val()),
    BuildingHeight: RealstrOrUndefined($("#RealEstateBuildingHeight").val()),

    LOISent: RealdateOrUndefined($("#RealEstateLOISent").val()),
    LOISigned: RealdateOrUndefined($("#RealEstateLOISigned").val()),
    PermitIssuedDate: RealdateOrUndefined($("#RealEstatePermitIssuedDate").val()),
    ProjectedOpeningDate: RealdateOrUndefined($("#RealEstateProjectedOpeningDate").val()),
    ApprovalDate: RealdateOrUndefined($("#RealEstateApprovalDate").val()),
    TurnoverDate: RealdateOrUndefined($("#RealEstateTurnoverDate").val()),
    PurchasedDate: RealdateOrUndefined($("#RealEstatePurchasedDate").val()),

    MortgageBalance: RealnumOrUndefined($("#RealEstateMortgageBalance").val()),
    OptionTerms: RealstrOrUndefined($("#RealEstateOptionTerms").val()),
    InitialTerms: RealstrOrUndefined($("#RealEstateInitialTerms").val()),

    LeaseComDate: RealdateOrUndefined($("#RealEstateLeaseComDate").val()),
    LeaseExpDate: RealdateOrUndefined($("#RealEstateLeaseExpDate").val()),

    PermitAppliedFor: RealstrOrUndefined($("#RealEstatePermitAppliedFor").val()),
    GeneralContractorSelected: RealstrOrUndefined($("#RealEstateGeneralContractorSelected").val())
  };

  $.ajax({
    url: REAL_ESTATE_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {

      if (typeof res === "string") res = JSON.parse(res);

      if (res.Status === "Successfully Submitted" ||
          res.Status === "Successfully Updated") {
            $("#shortAlertText").text("Data saved successfully");
      $("#shortAlert").modal("show");

       // alert(res.Status);
        $("#add_real_estate").modal("hide");
        realEstateId = 0; // reset

        getAllRealEstate(); //  refresh table
      } else {
        $("#shortAlertText").text(res.Status || "Something went wrong");
      $("#shortAlert").modal("show");
      //  alert(res.Status || "Something went wrong");
      }
    },
    error: function () {
       $("#shortAlertText").text("Something went wrong. Please try again");
      $("#shortAlert").modal("show");
    //  alert("Something went wrong. Please try again");
    }
  });
}



function getAllRealEstate() {
const payload = {
    
    Email: localStorage.getItem("loginEmail"),
    
  };

  $.ajax({
    url: REAL_ESTATE_GETALL_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {
  

      if (typeof res === "string") res = JSON.parse(res);
      console.log(res);

      if (!res || res.length === 0 || res.Status==="No record found") {
        $("#tblRealEstate tbody").html(
          `<tr><td colspan="6" class="text-center">No records found</td></tr>`
        );
        return;
      }
      if(res.Status==="Success"){
      
         bindRealEstateTable(res.RealEstate);
    
      }
      else{
          $("#tblRealEstate tbody").html(
          `<tr><td colspan="6" class="text-center">No records found</td></tr>`
        );
        return;
      }
    },
    error: function () {
         $("#shortAlertText").text("Failed to fetch real estate records");
      $("#shortAlert").modal("show");
     // alert("Failed to fetch real estate records");
    }
  });
}
function bindRealEstateTable(data) {

  let html = "";

  data.forEach((item, index) => {

    html += `
      <tr>
        <td>${index + 1}</td>
        <td>
          <p class="address_sec">${item.RealEstateAddress || "-"}</p>
        </td>
        <td>
          <p class="date_se">${item.PurchasedDate ? formatDate(item.PurchasedDate) : "-"}</p>
        </td>
        <td style="text-align:right">
          <p class="amount">${item.OriginalCost ? formatAmount(item.OriginalCost) : "-"}</p>
        </td>
        <td style="text-align:right">
          <p class="amount">${item.PresentValue ? formatAmount(item.PresentValue) : "-"}</p>
        </td>
        <td>
          <div class="button_act">
            <a href="javascript:void(0)" onclick="editRealEstate(${item.Id})">
              <i class="fa fa-edit"></i>
            </a>
            <a href="javascript:void(0)" onclick="deleteRealEstate(${item.Id})">
              <i class="fa fa-trash"></i>
            </a>
          </div>
        </td>
      </tr>`;
  });

  $("#tblRealEstate tbody").html(html);
}

function formatAmount(val) {
  if (val === null || val === undefined) return "0.00";
  return Number(val).toFixed(2);
}
function formatDate(dateVal) {
  if (!dateVal) return "-";
  const d = new Date(dateVal);
  return d.toLocaleDateString("en-GB", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

 


function deleteRealEstate(id) {

  if (!confirm("Are you sure you want to delete this record?")) return;

  const payload = {
    
    Email: localStorage.getItem("loginEmail"),
    Id: id
  };

  $.ajax({
    url: REAL_ESTATE_DELETE_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {

      if (typeof res === "string") res = JSON.parse(res);
 $("#shortAlertText").text(res.Status || "Deleted successfully");
      $("#shortAlert").modal("show");
      //alert(res.Status || "Deleted successfully");

      // Refresh table
      getAllRealEstate();
    },
    error: function () {
      $("#shortAlertText").text("Delete failed");
      $("#shortAlert").modal("show");
      //alert("Delete failed");
    }
  });
}


function editRealEstate(id) {
  realEstateId = id; //  THIS is what enables update


   const payload = {
    
    Email: localStorage.getItem("loginEmail"),
    Id: id
  };

  $.ajax({
    url: REAL_ESTATE_GETBYID_FLOW_URL,
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify(payload),
    success: function (res) {
   

      if (typeof res === "string") res = JSON.parse(res);
      if (!res) return;

      $("#RealEstateDealType").val(res.DealType);
      $("#RealEstatePresentValue").val(res.PresentValue);
      $("#RealEstateOriginalCost").val(res.OriginalCost);

      $("#RealEstateAddress").val(res.RealEstateAddress);
      $("#RealEstateSiteStreet1").val(res.SiteStreet1);
      $("#RealEstateSiteStreet2").val(res.SiteStreet2);
      $("#RealEstateSiteCity").val(res.SiteCity);
      $("#RealEstateState").val(res.State);
      $("#RealEstateCountry").val(res.Country);

      $("#RealEstateParkingSpaces").val(res.ParkingSpaces);
      $("#RealEstatePurchaseOption").val(res.PurchaseOption);

      $("#RealEstateBuildingSize").val(res.BuildingSize);
      $("#RealEstateBuildingLength").val(res.BuildingLength);
      $("#RealEstateBuildingBreadth").val(res.BuildingBreadth);
      $("#RealEstateBuildingHeight").val(res.BuildingHeight);

      setDate("#RealEstateLOISent", res.LOISent);
      setDate("#RealEstateLOISigned", res.LOISigned);
      setDate("#RealEstatePermitIssuedDate", res.PermitIssuedDate);
      setDate("#RealEstateProjectedOpeningDate", res.ProjectedOpeningDate);
      setDate("#RealEstateApprovalDate", res.ApprovalDate);
      setDate("#RealEstateTurnoverDate", res.TurnoverDate);
      setDate("#RealEstatePurchasedDate", res.PurchasedDate);

      $("#RealEstateMortgageBalance").val(res.MortgageBalance);
      $("#RealEstateOptionTerms").val(res.OptionTerms);
      $("#RealEstateInitialTerms").val(res.InitialTerms);

      setDate("#RealEstateLeaseComDate", res.LeaseComDate);
      setDate("#RealEstateLeaseExpDate", res.LeaseExpDate);

      $("#RealEstatePermitAppliedFor").val(res.PermitAppliedFor);
      $("#RealEstateGeneralContractorSelected").val(res.GeneralContractorSelected);

      $("#add_real_estate").modal("show");
    }
  });
}

 

function setDate(selector, value) {
  $(selector).val(value ? value.split("T")[0] : "");
}
